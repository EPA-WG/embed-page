<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../imported-template/imported-template.html">
<dom-module id="embed-page">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <h2>from <a href="[[src]]" target="_blank">[[src]]</a></h2>
        <hr/>
        <div id="framed" ></div>

    </template>
    <script>
( function( win, doc )
{
    /**
     * `embed-page`
     * embed page in iframe fashion
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class EmbedPage extends Polymer.Element
    {
        static get is() { return 'embed-page'; }

        static get properties()
        {
            return  {   src:    {   type: String
                                ,   value: 'embed-page'
                                ,   observer: 'fetch'
                                }
                    };
        }
        // ready(){   super.ready(); this.fetch() } - no need as observer performs fetch
        fetch()
        {   const f = this.$f = this.$.framed;
            this.onBeforeFetch();
            fetch( this.src )
            .then( response => response.text() )
            .then( t =>
            {   let el = doc.createElement('div');
                el.innerHTML =  t;
                // todo link[rel=stylesheet] to <style> @import "../my/path/style.css"; </style>
                let $s = $( scriptsSelector, el );//.detach();
                f.appendChild( el );
                this.runScripts( $s );
                this.onAfterFetch();
            }, err => f.innerHTML =  "Technical error" );
        }
        onBeforeFetch(){ addClass   ( this.$f,'loading') }
        onAfterFetch (){ removeClass( this.$f,'loading') }

        get context()
        {   const f = this.$.framed;
            return  {   window      : win
                    ,   document    :   {   getElementById:  id => $( '#'+id, f )[0]
                                        ,   getElementsByTagName: x => $( x, f )
                                        ,   createElement: x=> doc.createElement(x)
                                        ,   location: { protocol : doc.location.protocol }
                                        }
                    ,   head        : doc.head
                    ,   body        : doc.body
                    }
        }

        runScripts( /** @type {!NodeList} */ pageScripts, { win, document, head, body } = this.context )
        {   const env = this.context;
            forEach( pageScripts, currentScript => EPA_runScript( currentScript, env ));
        }
        runScriptsRaw( { window, document, head, body } = this.context )
        {
            forEach( content.querySelectorAll(scriptsSelector), currentScript =>
            {   const clone = /** @type {!HTMLScriptElement} */( script.ownerDocument.createElement('script') );
                forEach(script.attributes, attr => clone.setAttribute(attr.name, attr.value));
                clone.textContent = script.textContent;
                script.parentNode.insertBefore(clone, script);
                script.parentNode.removeChild(script);
            });
        }
    }
    const scriptsSelector = 'script:not([type]),script[type="application/javascript"],script[type="text/javascript"]';

    function forEach(arr,cb){[...arr].forEach(cb)}
    function $( css, el = doc ){ return el.querySelectorAll( css ) }
    function addClass   ( el, className  ){ el.className += ' '+className    }
    function removeClass( el, className  ){ el.className = el.className.split(' ').map(s=>s===className?'':s).join(' ') }

    // outside of class to avoid strict mode
    function EPA_runScript( currentScript, { window, document, head, body } )
    {
        console.debug( "embed-page", currentScript.src || currentScript.text );
        if( currentScript.src )
            fetch( currentScript.src )
                .then( response => response.text() )
                .then( txt => runScript( txt + "//# sourceURL=" + currentScript.src ) );
        else
            runScript( currentScript.text );// todo src map

        function runScript( txt )
        {   try
            {   eval(txt);
            }catch(ex){ console.error(ex) }
        }
    }

    win.customElements.define( EmbedPage.is, EmbedPage );
})( window, document );

    </script>
</dom-module>
