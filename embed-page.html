<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../imported-template/imported-template.html">
<dom-module id="embed-page">
    <template>
        <style>
            :host {
                display: block;
            }
            iframe{display: none;}
        </style>
        <div id="framed" ><slot></slot></div>
        <!--base target="target-frame"/-->
        <iframe id="targetframe" name$="target-frame[[getInstanceNum()]]" on-load="onTargetLoad" src=""></iframe>
    </template>
    <script>
( function( win, doc )
{
    const   FRAME_HASH_PREFIX   = '#embed-page='
    ,       FRAME_BLANK         = "about:blank";
    let     GBL_InstancesCount  = 0;

    /**
     * `embed-page`
     * embeds page in iframe fashion but using shadow dom for CSS and dom insulation and closure for JS jailing.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class EmbedPage extends Polymer.Element
    {
        static get is() { return 'embed-page' }

        static get properties()
        {
            return  {   src:    {   type: String
                                ,   value: ''
                                ,   observer: 'fetch'
                                }
                    ,   redirects:  {   type: Array
                                    ,   value:  ()=>[]
                                    }
                    };
        }
        constructor()
        {   super();
            this._InstanceNum = GBL_InstancesCount++;
        }
        getInstanceNum(){ return this._InstanceNum }

        fetch()
        {   const f = this.$f = this.$.framed;
            this.onBeforeFetch();
            this.src && ajax( this.src )
            .then( t =>
            {   let el = doc.createElement('div');
                el.innerHTML =  t;
                // todo link[rel=stylesheet] to <style> @import "../my/path/style.css"; </style>
                let $s = $( scriptsSelector, el );// skip detach() as code could expect script tags present;
                f.innerHTML='';
                f.appendChild( el );
                this.runScripts( $s );
                this.onAfterFetch();
            }, err => f.innerHTML =  "Technical error" );
        }
        onBeforeFetch(){ addClass   ( this.$f,'loading') }
        onAfterFetch (){ removeClass( this.$f,'loading') }

        get context()
        {   const f = this.$.framed;
            return  {   window      : win
                    ,   document    :   {   getElementById:  id => $( '#'+id, f )[0]
                                        ,   getElementsByTagName: x => $( x, f )
                                        ,   getElementsByClassName: x => f.getElementsByClassName( x )
                                        ,   createElement   : x=> doc.createElement(x)
                                        ,   querySelectorAll: x=> f.querySelectorAll(x)
                                        ,   querySelector   : x=> f.querySelector(x)
                                        ,   location: { protocol : doc.location.protocol }
                                        }
                    ,   head        : doc.head
                    ,   body        : doc.body
                    }
        }

        runScripts( /** @type {!NodeList} */ pageScripts, { win, document, head, body } = this.context )
        {   const env = this.context;
            EPA_runScript( [...pageScripts], env, this.redirects );
        }
        runScriptsRaw( { window, document, head, body } = this.context )
        {
            forEach( content.querySelectorAll(scriptsSelector), currentScript =>
            {   const clone = /** @type {!HTMLScriptElement} */( script.ownerDocument.createElement('script') );
                forEach(script.attributes, attr => clone.setAttribute(attr.name, attr.value));
                clone.textContent = script.textContent;
                script.parentNode.insertBefore(clone, script);
                script.parentNode.removeChild(script);
            });
        }
        ready()
        {   super.ready();
            this.$.framed.addEventListener( 'click', this._onClick.bind(this), true );
        }
        url2hash( el, attr )
        {   el.target = this.$.targetframe.getAttribute( 'name' );
            if( !el[attr].includes(FRAME_HASH_PREFIX) )
                el[attr] = FRAME_HASH_PREFIX+encodeURIComponent( el[attr] )
        }
        _onClick(ev)
        {   const $f = this.$.framed;
            for( let el = ev.target; el && el!==$f ; el = el.parentElement )
            {   const a = { A:'href', FORM:'action'}[ el.tagName ];
                if( a )
                    return this.url2hash( el, a );
                // todo POST handling
            }
        }
        onTargetLoad(ev)
        {
            const   fr  = ev.target
            ,       url = fr.contentWindow.location.href;
            if( url.includes(FRAME_BLANK) )
                return;
            console.log("onTargetLoad:"+url);
            const decoded = decodeURIComponent( url.substring( url.indexOf(FRAME_HASH_PREFIX)+FRAME_HASH_PREFIX.length ) );
            fr.src = FRAME_BLANK;
            this.src = decoded;
        }
    }
    const scriptsSelector = 'script:not([type]),script[type="application/javascript"],script[type="text/javascript"]';

    //ajax('https://www.cahousefinder.com/wp-includes/js/jquery/jquery.js?ver=1.11.0','GET').then(
    //    x=>{
    //        debugger;
    //    },
    //    err=>{
    //        debugger;
    //    }
    //);

    //if ('serviceWorker' in navigator)
    //    //navigator.serviceWorker.register('https://cdn.xml4jquery.com/ajax/poc/sw.js' // not allowed as page has different origin
    //    navigator.serviceWorker.register('sw.js'
    //            , { scope: 'https://www.cahousefinder.com/' }) // not allowed as scope should have same origin as service worker js
    //    .then(function(sw) {
    //      log('ServiceWorker registration successful with scope: ',    sw.scope, sw);
    //      log("You should get a different response when you refresh");
    //    }).catch(function(err) {
    //      log("Error", err);
    //    });

    //fetch( 'https://www.cahousefinder.com/wp-includes/js/jquery/jquery.js?ver=1.11.0', { mode: 'no-cors' } )
    //.then( r => r.text() )
    //.then(
    //    x=>{
    //        debugger;
    //    },
    //    err=>{
    //        debugger;
    //    }
    //);

    win.customElements.define( EmbedPage.is, EmbedPage );

    return;

    function log( ...args  ){ console.log(...args); }
    function forEach(arr,cb){[...arr].forEach(cb)}
    function $( css, el = doc ){ return el.querySelectorAll( css ) }
    function addClass   ( el, className  ){ el.className += ' '+className    }
    function removeClass( el, className  ){ el.className = el.className.split(' ').map(s=>s===className?'':s).join(' ') }


    // outside of class to avoid strict mode
    function EPA_runScript( arr, env, redirects )
    {   let { window, document, head, body } = env;
        let currentScript = arr.shift();
        if( !currentScript )
            return;
        console.debug( "embed-page", currentScript.src || currentScript.text );
        if( currentScript.src )
        {
            let url = currentScript.src;

            let m = redirects.find( m => url.startsWith( m.from ) );
            if( m )
                url = m.to + url.substring( m.from.length );
            ajax( url )
                .then( txt => runScript( txt + "//# sourceURL=" + currentScript.src ) );
        }else
            runScript( currentScript.text );// todo src map

        function runScript( txt )
        {   try
            {   eval(txt);
            }catch(ex){ console.error(ex) }
            setTimeout( x=> EPA_runScript( arr, env, redirects ), 0 );
        }
    }

    function ajax( url, method = "GET", headers = {}, body = undefined )
    {
        return new Promise( ( resolve, reject ) =>
        {   const xhr = new XMLHttpRequest();
            xhr.open( method, url );
            headers && Object.keys( headers ).forEach( key => xhr.setRequestHeader( key, headers[ key ] ) );

            xhr.onload  = () =>
            {   if( xhr.status >= 200 && xhr.status < 300 )
                    resolve( xhr.response );
                else
                    reject( xhr.statusText );
            };
            xhr.onerror = () => reject( url + 'failed' +xhr.statusText );
            xhr.send( body );
        })
    }

})( window, document );

    </script>
</dom-module>
